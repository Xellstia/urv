<%# app/views/presets/index.html.erb — Расписание в каркасе Timesheets %>

<%# Сколько колонок: 5 (по умолчанию) или 7, если контроллер всё ещё даёт @show_weekend %>
<% cols  = (defined?(@show_weekend) && @show_weekend) ? 7 : 5 %>
<% day_w = 'clamp(260px, 18vw, 340px)' %>

<div class="space-y-4 mt-8">
  <!-- Заголовок раздела (без переключателей недель/выходных) -->
  <div class="ts-rail">
    <div class="ts-strip px-4" style="--cols:<%= cols %>; --day-w:<%= day_w %>">
      <div class="py-1">
        <div class="text-base font-semibold text-slate-700">Расписание</div>
      </div>
    </div>
  </div>

  <!-- Лента дней -->
  <div class="ts-rail">
    <div class="ts-strip px-4" style="--cols:<%= cols %>; --day-w:<%= day_w %>">
      <div class="flex gap-day py-1">
        <% @weekdays.each do |wd| %>
          <%# Ровно как в старом шаблоне: берём первый бакет и его preset_items %>
          <% presets_for_day = (@items_by_weekday[wd]&.first&.preset_items || []) %>

          <% total_min = presets_for_day.sum { |pi| pi.respond_to?(:minutes_spent) ? pi.minutes_spent.to_i : 0 } %>
          <% frame_id  = preset_day_frame_id(wd) %>

          <div class="w-day shrink-0">
            <div class="rounded-2xl bg-white shadow-md p-3">
              <!-- Шапка дня -->
              <div class="flex items-center justify-between">
                <div class="text-lg font-semibold"><%= weekday_name(wd) %></div>
                <div class="ts-day-subtle"><%= (total_min/60.0).round(1) %>h / 8h</div>
              </div>
              <div class="mt-2 h-2 rounded-full bg-slate-200 overflow-hidden">
                <div class="h-full bg-blue-500" style="width:<%= [(total_min / (8.0*60) * 100), 100].min %>%"></div>
              </div>

              <!-- Зона добавления: два сегмента Tempo / Яга -->
              <div class="mt-3">
                <div class="relative group rounded-xl border border-slate-300 bg-white h-11">
                  <!-- «Покой» -->
                  <div class="absolute inset-0 flex items-center justify-center text-[14px] text-slate-400 transition-opacity duration-150 group-hover:opacity-0">
                    Добавить строку
                  </div>

                  <!-- Сегменты -->
                  <div class="absolute inset-0 opacity-0 pointer-events-none transition duration-150 group-hover:opacity-100 group-hover:pointer-events-auto rounded-xl overflow-hidden">
                    <div class="flex h-full divide-x divide-slate-300/70">
                      <% preset_bucket = Preset.find_by(user_id: current_user.id, weekday: wd) %>

                      <!-- Tempo -->
                      <%= link_to new_preset_preset_item_path(preset_bucket, frame_id: frame_id, system: :tempo),
                                  data: { turbo_frame: frame_id },
                                  class: "flex-1 h-full flex items-center justify-center text-[13px] font-medium text-blue-700 hover:bg-blue-50" do %>
                        Tempo
                      <% end %>

                      <!-- Яга -->
                      <%= link_to new_preset_preset_item_path(preset_bucket, frame_id: frame_id, system: :yaga),
                                  data: { turbo_frame: frame_id },
                                  class: "flex-1 h-full flex items-center justify-center text-[13px] font-medium text-emerald-700 hover:bg-emerald-50" do %>
                        Яга
                      <% end %>
                    </div>
                  </div>
                </div>

                <!-- Фрейм, куда подгружается форма создания/редактирования -->
                <turbo-frame id="<%= frame_id %>"></turbo-frame>
              </div>

              <!-- Карточки дня (как раньше) -->
              <div id="preset_day_list_<%= wd %>" class="mt-3 flex flex-col gap-3">
                <% if presets_for_day.any? %>
                  <% presets_for_day.each do |pi| %>
                    <%= render "preset_items/card", pi: pi %>
                  <% end %>
                <% else %>
                  <p class="text-sm text-gray-400">Пока пусто. Здесь будут шаблонные карточки.</p>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>
