<div class="space-y-8 p-4 max-w-6xl mx-auto">
  <div>
    <h1 class="text-2xl font-semibold text-slate-900">Настройки</h1>
    <p class="text-sm text-slate-500">Управление интеграциями и значениями по умолчанию.</p>
  </div>

  <div class="grid gap-6 lg:grid-cols-2 xl:grid-cols-3">
    <section class="rounded-2xl bg-white shadow p-6 border border-slate-100 space-y-4 lg:col-span-2 xl:col-span-1">
      <div>
        <h2 class="text-lg font-semibold text-slate-900">Учётные данные</h2>
        <p class="text-sm text-slate-500">Используются при выгрузке карточек в соответствующие системы.</p>
      </div>

      <%= form_with model: @user, url: settings_path(section: :credentials), method: :patch, class: "space-y-4" do |f| %>
        <div>
          <h3 class="text-sm font-semibold text-slate-700 mb-2">Tempo</h3>
          <div class="space-y-2">
            <%= f.text_field :tempo_login, placeholder: "Логин", class: "ui-input" %>
            <%= f.password_field :tempo_password, placeholder: "Пароль", class: "ui-input" %>
          </div>
        </div>

        <div>
          <h3 class="text-sm font-semibold text-slate-700 mb-2">Яга</h3>
          <div class="space-y-2">
            <%= f.text_field :yaga_login, placeholder: "Логин", class: "ui-input" %>
            <%= f.password_field :yaga_password, placeholder: "Пароль", class: "ui-input" %>
          </div>
        </div>

        <div>
          <h3 class="text-sm font-semibold text-slate-700 mb-2">OTRS</h3>
          <div class="space-y-2">
            <%= f.text_field :otrs_login, placeholder: "Логин", class: "ui-input" %>
            <%= f.password_field :otrs_password, placeholder: "Пароль", class: "ui-input" %>
          </div>
        </div>

        <div class="flex justify-end">
          <%= f.submit "Сохранить", class: "btn-primary" %>
        </div>
      <% end %>
    </section>

    <!-- Yaga defaults -->
    <section class="rounded-2xl bg-white shadow p-6 border border-slate-100 space-y-4">
      <div>
        <h2 class="text-lg font-semibold text-slate-900">Яга — значения по умолчанию</h2>
        <p class="text-sm text-slate-500">Подставляются при создании карточки Яга.</p>
      </div>

      <%= form_with url: settings_path(section: :yaga_defaults), method: :patch, class: "space-y-4" do %>
        <div>
          <label class="ui-label">Номер задачи</label>
          <%= text_field_tag "yaga_defaults[issue_key]", @user.yaga_defaults["issue_key"], class: "ui-input", placeholder: "LZ-1234" %>
        </div>
        <div>
          <label class="ui-label">Пространство</label>
          <%= text_field_tag "yaga_defaults[workspace]", @user.yaga_defaults["workspace"], class: "ui-input", placeholder: "Main" %>
        </div>
        <div>
          <label class="ui-label">Вид работ</label>
          <%= text_field_tag "yaga_defaults[work_kind]", @user.yaga_defaults["work_kind"], class: "ui-input", placeholder: "meeting" %>
        </div>
        <div class="flex justify-end">
          <%= submit_tag "Сохранить", class: "btn-primary" %>
        </div>
      <% end %>
    </section>

    <!-- Tempo defaults -->
    <section class="rounded-2xl bg-white shadow p-6 border border-slate-100 space-y-4">
      <div>
        <h2 class="text-lg font-semibold text-slate-900">Tempo — значения по умолчанию</h2>
        <p class="text-sm text-slate-500">Подставляются при создании карточки Tempo.</p>
      </div>

      <%= form_with url: settings_path(section: :tempo_defaults), method: :patch, class: "space-y-4" do %>
        <div>
          <label class="ui-label">Номер задачи</label>
          <%= text_field_tag "tempo_defaults[issue_key]", @user.tempo_defaults["issue_key"], class: "ui-input", placeholder: "APP-123" %>
        </div>
        <div>
          <label class="ui-label">Вид работ</label>
          <%= select_tag "tempo_defaults[work_kind_id]",
                        options_from_collection_for_select(@tempo_attributes["work_kind"] || [], :external_id, :name, @user.tempo_defaults["work_kind_id"]),
                        include_blank: "Не выбрано",
                        class: "ui-select" %>
        </div>

        <div>
          <label class="ui-label">ЦС действия</label>
          <%= select_tag "tempo_defaults[cs_action_id]",
                        options_from_collection_for_select(@tempo_attributes["cs_action"] || [], :external_id, :name, @user.tempo_defaults["cs_action_id"]),
                        include_blank: "Не выбрано",
                        class: "ui-select" %>
        </div>

        <div>
          <label class="ui-label">ЦС ИС</label>
          <%= select_tag "tempo_defaults[cs_is_id]",
                        options_from_collection_for_select(@tempo_attributes["cs_is"] || [], :external_id, :name, @user.tempo_defaults["cs_is_id"]),
                        include_blank: "Не выбрано",
                        class: "ui-select" %>
        </div>

        <div class="flex justify-end">
          <%= submit_tag "Сохранить", class: "btn-primary" %>
        </div>
      <% end %>
    </section>
  </div>

  <!-- Visibility -->
  <section class="rounded-2xl bg-white shadow p-6 border border-slate-100 space-y-4">
    <div>
      <h2 class="text-lg font-semibold text-slate-900">Tempo — видимость справочников</h2>
      <p class="text-sm text-slate-500">Отметьте элементы, которые должны отображаться в формах.</p>
    </div>

    <%= form_with url: settings_path(section: :tempo_visibility), method: :patch, class: "space-y-6" do %>
      <div class="grid gap-6 md:grid-cols-3">
        <% { "work_kind" => "Вид работ", "cs_action" => "ЦС действия", "cs_is" => "ЦС ИС" }.each do |category, title| %>
          <div class="space-y-3 rounded-xl border border-slate-100 bg-slate-50 p-4">
            <h3 class="text-sm font-semibold text-slate-700"><%= title %></h3>
            <%= hidden_field_tag "visibility[#{category}][]", "" %>
            <div class="space-y-2 max-h-64 overflow-y-auto pr-2">
              <% items = @tempo_attributes[category] || [] %>
              <% pref = @visibility[category]&.visible_ids %>
              <% items.each do |attribute| %>
                <% checked = pref.nil? || pref.include?(attribute.external_id) %>
                <label class="flex items-center gap-2 text-sm text-slate-600">
                  <%= check_box_tag "visibility[#{category}][]", attribute.external_id, checked, class: "rounded border-slate-300" %>
                  <span><%= attribute.name %></span>
                </label>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>

      <div class="flex justify-end">
        <%= submit_tag "Обновить", class: "btn-primary" %>
      </div>
    <% end %>
  </section>
</div>
