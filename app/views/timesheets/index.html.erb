<% cols  = @show_weekend ? 7 : 5 %>
<% day_w = @show_weekend ? 'clamp(150px, 14vw, 300px)' : 'clamp(220px, 18vw, 340px)' %>

<!-- --day-w на весь экран таймшитов, чтобы унаследовали обе полосы -->
<div class="ts-viewport space-y-4 mt-8" style="--day-w: <%= day_w %>">
  <!-- Шапка таймшитов (НЕ sticky) -->
  <div class="ts-rail">
    <div class="ts-strip" style="--cols: <%= cols %>">
      <div class="flex items-center justify-between py-2">
        <div class="flex items-center gap-2">
          <%= link_to "←",
                      { week_start: (@week_start - 7), weekend: @show_weekend },
                      class: "px-3 py-2 rounded border hover:bg-gray-50" %>
          <div class="font-semibold">
            <%= @week_start.strftime("%d %b") %> – <%= (@week_start + 6).strftime("%d %b %Y") %>
          </div>
          <%= link_to "→",
                      { week_start: (@week_start + 7), weekend: @show_weekend },
                      class: "px-3 py-2 rounded border hover:bg-gray-50" %>
        </div>

        <div data-controller="weekend-toggle">
          <label class="inline-flex items-center gap-2 cursor-pointer">
            <input type="checkbox"
                   data-weekend-toggle-target="toggle"
                   data-action="weekend-toggle#change"
                   <%= "checked" if @show_weekend %>>
            <span>Показать выходные</span>
          </label>
        </div>
      </div>
    </div>
  </div>

  <!-- Лента дней (прокручивается) -->
  <div class="ts-rail">
    <div class="ts-strip" style="--cols: <%= cols %>">
      <div class="flex gap-day py-1">
        <% @days.each do |day| %>
          <% next unless @show_weekend || (1..5).cover?(day.cwday) %>

          <% items     = @items_by_day[day] || [] %>
          <% total_min = @totals_by_day[day] || 0 %>
          <% frame_id  = day_frame_id(day) %>

          <div class="w-day shrink-0">
            <!-- Колонка дня: без рамки, с мягкой тенью -->
            <div class="rounded-2xl bg-white shadow-md p-3">
              <!-- Шапка дня -->
              <div id="<%= day_header_dom_id(day) %>">
                <%= render "day_header", day: day, total_min: total_min %>
              </div>

              <!-- ЗОНА ДОБАВЛЕНИЯ — тонкий фрейм с 4 сегментами -->
              <div class="mt-3">
                <div class="relative group rounded-xl border border-slate-300 bg-white h-11">
                  <!-- «Покой» -->
                  <div class="absolute inset-0 flex items-center justify-center text-[14px] text-slate-400 transition-opacity duration-150 group-hover:opacity-0">
                    Добавить задачу
                  </div>

                  <!-- Плитка-сегменты -->
                  <div class="absolute inset-0 opacity-0 pointer-events-none transition duration-150 group-hover:opacity-100 group-hover:pointer-events-auto rounded-xl overflow-hidden">
                    <div class="flex h-full divide-x divide-slate-300/70">
                      <!-- Tempo -->
                      <%= link_to new_work_item_path(system: :tempo, date: day, week_start: @week_start, weekend: @show_weekend, frame_id: frame_id),
                                  data: { turbo_frame: frame_id },
                                  class: "flex-1 h-full flex items-center justify-center text-[13px] font-medium text-blue-700 hover:bg-blue-50" do %>
                        Tempo
                      <% end %>

                      <!-- Расписание (иконка) -->
                      <%= link_to prefill_timesheet_path(date: day, week_start: @week_start, weekend: @show_weekend),
                                  data: { turbo_method: :post },
                                  title: "Предзаполнить с расписания",
                                  class: "w-11 h-full flex items-center justify-center hover:bg-amber-50",
                                  aria: { label: "Предзаполнить с расписания" } do %>
                        <%= image_tag "ui/schedule.svg", class: "h-5 w-5", alt: "" %>
                      <% end %>

                      <!-- Шаблоны (иконка) -->
                      <%= link_to templates_picker_path(date: day, week_start: @week_start, weekend: @show_weekend, frame_id: "modal", day_frame_id: frame_id),
                                  data: { turbo_frame: "modal" },
                                  title: "Добавить из шаблона",
                                  class: "w-11 h-full flex items-center justify-center hover:bg-purple-50",
                                  aria: { label: "Добавить из шаблона" } do %>
                        <%= image_tag "ui/templates.svg", class: "h-5 w-5", alt: "" %>
                      <% end %>

                      <!-- Яга -->
                      <%= link_to new_work_item_path(system: :yaga, date: day, week_start: @week_start, weekend: @show_weekend, frame_id: frame_id),
                                  data: { turbo_frame: frame_id },
                                  class: "flex-1 h-full flex items-center justify-center text-[13px] font-medium text-emerald-700 hover:bg-emerald-50" do %>
                        Яга
                      <% end %>
                    </div>
                  </div>
                </div>

                <!-- Фрейм, куда подгружается форма создания/редактирования -->
                <turbo-frame id="<%= frame_id %>"></turbo-frame>
              </div>

              <!-- Список карточек за день -->
              <div id="<%= day_list_dom_id(day) %>" class="mt-3 flex flex-col gap-3">
                <%= render "timesheets/day_list", items: items %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Модалка для шаблонов -->
<turbo-frame id="modal"></turbo-frame>
