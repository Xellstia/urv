<%# Партиал категории для turbo stream обновления %>
<% cat = local_assigns[:category] %>
<% list_id = "template_category_list_#{cat.id}" %>
<% category_id = "template_category_#{cat.id}" %>

<div id="<%= category_id %>"
     class="rounded-2xl bg-white shadow-md overflow-hidden"
     data-controller="template-category"
     data-template-category-url-value="<%= toggle_collapse_template_category_path(cat) %>"
     data-template-category-edit-mode-value="false">
  <!-- Заголовок категории -->
  <div class="px-4 py-1 flex flex-col gap-1.5 sm:flex-row sm:items-center sm:justify-between border-b border-transparent bg-slate-900"
       data-action="dblclick->template-category#toggle">
    <div data-template-category-target="nameWrapper"
         data-template-category-ignore="true"
         class="text-sm font-semibold text-white tracking-wide uppercase">
      <span data-template-category-target="nameDisplay"><%= cat.name %></span>
    </div>
    <div data-template-category-target="editWrapper"
         data-template-category-ignore="true"
         class="hidden w-full sm:w-auto">
      <%= form_with model: cat,
                    url: template_category_path(cat),
                    method: :patch,
                    local: true,
                    data: { action: "submit->template-category#save", template_category_target: "editForm", template_category_ignore: true },
                    class: "flex flex-col gap-2 sm:flex-row sm:items-center" do |f| %>
        <%= f.text_field :name,
                         value: cat.name,
                         class: "rounded-lg border border-white/40 bg-white/10 px-3 py-1 text-sm text-white uppercase tracking-wide placeholder-white/50 focus:outline-none focus:ring-0 focus:border-white/70",
                         data: { template_category_target: "nameInput" } %>
        <div class="flex items-center gap-2">
          <%= f.submit "Сохранить", class: "rounded-lg bg-white/20 px-3 py-1 text-xs font-semibold text-white" %>
          <button type="button" class="rounded-lg border border-white/30 px-3 py-1 text-xs text-white" data-action="template-category#cancelEdit">Отмена</button>
        </div>
      <% end %>
    </div>
    <div class="flex items-center gap-2">
      <!-- Кнопка добавления карточек (как в расписании) -->
      <div class="relative group rounded-2xl border border-white/30 bg-white/5 h-10 w-[230px] overflow-hidden"
           data-template-category-ignore="true">
        <div class="absolute inset-0 flex items-center justify-center text-[13px] text-white/80 transition-opacity duration-150 group-hover:opacity-0">
          Добавить карточку
        </div>
        <div class="absolute inset-0 opacity-0 pointer-events-none transition duration-150 group-hover:opacity-100 group-hover:pointer-events-auto">
          <div class="flex h-full divide-x divide-white/40">
            <%= link_to new_template_category_template_card_path(cat, frame_id: "modal", system: :tempo),
                        data: { turbo_frame: "modal" },
                        class: "flex-1 h-full flex items-center justify-center text-[13px] font-medium text-blue-100 hover:bg-blue-500/30" do %>
              Tempo
            <% end %>
            <%= link_to new_template_category_template_card_path(cat, frame_id: "modal", system: :yaga),
                        data: { turbo_frame: "modal" },
                        class: "flex-1 h-full flex items-center justify-center text-[13px] font-medium text-emerald-100 hover:bg-emerald-500/30" do %>
              Яга
            <% end %>
          </div>
        </div>
      </div>

      <%= render "template_categories/category_menu", category: cat %>
    </div>
  </div>

  <div class="<%= cat.collapsed ? 'hidden' : '' %>">
    <!-- Карточки категории -->
    <div class="p-4">
      <div id="<%= list_id %>" class="grid gap-4 w-full mx-auto"
           style="grid-template-columns: repeat(4, minmax(240px, 1fr)); max-width: 1400px;">
        <% if cat.template_cards.any? %>
          <% cat.template_cards.each do |tc| %>
            <%= render "template_cards/card", card: tc %>
          <% end %>
        <% else %>
          <div class="col-span-4 text-sm text-gray-400 py-4">Пока пусто. Добавьте карточки.</div>
        <% end %>
      </div>
    </div>
  </div>
</div>
