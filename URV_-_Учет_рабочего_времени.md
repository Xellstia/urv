# URV — учёт рабочего времени

Документ описывает фактическое состояние проекта на ноябрь 2025 г. и служит входной точкой для команды.

## 1. Назначение и ключевые идеи

- Унифицированный интерфейс для списания времени в Tempo, Ягу и (в перспективе) OTRS.
- Быстрый перенос типовых задач за счёт шаблонов, пресетов и предзаполнений.
- Фокус на компактном одностраничном UI: фиксированный топбар и сайдбар, основной контент без перезагрузок (Hotwire/Turbo).

## 2. Архитектура интерфейса

### 2.1 Навигация
- **Topbar**: логотип URV, название “Учёт Рабочего Времени”, данные текущего пользователя, кнопка выхода.
- **Sidebar**: иконки разделов (Расписание, Шаблоны, Timesheets, Настройки). Сайдбар умеет схлопываться; состояния хранятся в `localStorage`.

### 2.2 Timesheets (главный экран)
- **Неделя**: над сеткой — компактный блок с диапазоном дат и кнопками перелистывания (SVG `ui/left.svg`, `ui/right.svg`). По клику меняется `week_start`.
- **Weekend toggle**: чекбокс “Показать выходные” на Stimulus‑контроллере `weekend-toggle`, хранит состояние в параметрах URL.
- **Дневные колонки**:
  - ширина рассчитывается через CSS переменные `--day-w`, `--cols`;
  - каждая колонка показывает дата, прогресс‑бар 8h, статистику по минутам.
- **Зона “Добавить задачу”**: при наведении раскрывается на четыре сегмента:
  1. Tempo (форма в Turbo Frame),
  2. Предзаполнить из расписания,
  3. Добавить из шаблонов (открывает модалку picker),
  4. Яга.
- **Карточки**: рендерятся через `shared/_card`, поддерживают состояния (draft/synced/incomplete), dblclick → редактирование в модалке.
- **Модальное окно templates_picker**: позволяет подобрать шаблонную карточку за выбранный день и добавить её в поток timesheet.

### 2.3 Шаблоны (template_categories)
- **Хедер страницы**: форма создания категории + список в ширину до `max-w-7xl`.
- **Категории**:
  - карточки отображаются в белых контейнерах с тёмной шапкой;
  - шапка содержит название, кнопку “Добавить карточку” (hover‑фрейм Tempo/Яга) и меню настроек (gear.svg).
- **Inline‑переименование**:
  - опция “Переименовать” в меню вызывает Stimulus‑контроллер `template-category`;
  - название превращается в текстовое поле с кнопками “Сохранить/Отмена”;
  - запрос PATCH выполняется без перезагрузки, заголовок обновляется на клиенте.
- **Карточки категории**:
  - выводятся сеткой строго по 4 карточки в ряд (`grid-template-columns: repeat(4, minmax(240px, 1fr))`, `max-width: 1400px`);
  - карточки можно открывать на редактирование двойным кликом; форма всегда рендерится в модальном окне.
- **Создание/редактирование карточек**:
  - модальное окно фиксированной ширины `min(460px, 86vw)`;
  - используются общие партиалы `shared/_work_form` + `template_cards/_form_(tempo|yaga)`;
  - после submit Turbo Stream добавляет/обновляет карточку и закрывает модалку.

### 2.4 Расписание (presets)
- Предоставляет недельные шаблоны (“Еженед. шаблоны”).
- Колонки ведут себя как в timesheets: прогресс‑бар, зона “Добавить строку” (Tempo/Яга), карточки пресетов.
- Используется для заполнения timesheets через кнопку “Предзаполнить”.

### 2.5 Страница входа
- Доступна только неавторизованным пользователям (layout скрывает топбар/сайдбар).
- Центрированный карточный блок с логотипом URV, заголовком и формой авторизации.
- Поля и тексты на русском языке: Email, Пароль, “Запомнить меня”, кнопка “Войти”.
- Дополнительные ссылки: регистрация и восстановление пароля (если включено в Devise).

### 2.6 Настройки пользователя (развиваем)
- Вкладка «Учётные данные» уже доступна: можно задать логины/пароли Tempo, Яга, OTRS (хранятся шифрованно, без тестового запроса).
- Tempo:
  - доступны поля значений по умолчанию (номер задачи, Work Kind / ЦС Действия / ЦС ИС).
  - можно скрывать элементы справочников (фильтрация применяется в формах WorkItem и TemplateCard).
- Яга:
  - доступны поля значений по умолчанию (номер задачи, пространство, вид работ).
- OTRS — пока только ввод логина/пароля (остальной функционал в планах).
- Справочники Tempo синхронизируются job `Tempo::SyncAttributesJob`, которую запускает администратор (Sidekiq Web UI, тех. учётка из `.env`).

## 3. Технологический стек
- **Backend**: Ruby on Rails 7, Postgres.
- **Hotwire**: Turbo (frame + stream), Stimulus.
- **Stimulus‑контроллеры**: `sidebar`, `modal`, `weekend-toggle`, `time-input`, `form-close`, `template-category`, `accordion`.
- **UI**: Tailwind (через `app/assets/tailwind/application.css`), кастомные SVG‑иконки в `app/assets/images/ui`.

## 4. Состояние разработки

### Реализовано
1. Базовый макет (topbar, sidebar, scrollable content).
2. Timesheets:
   - неделя/выходные,
   - зоны добавления Tempo/Яга/шаблонов/расписания,
   - picker шаблонов,
   - модальные формы создания/редактирования задач.
3. Раздел “Шаблоны”:
   - категории (создание, удаление, inline rename, сворачивание),
   - карточки (сеткой, модальные формы Tempo/Яга),
   - Stimulus‑контроллеры для rename и dropdown‑меню.
4. “Расписание” (preset items) — набор постоянных шаблонов по дням недели.

### В работе / backlog
1. Интеграции с API Tempo/Яга/OTRS: получение worker/issue id, отправка worklog’ов под учёткой пользователя.
2. Расширение настроек: проверка подключений, defaults и фильтры для Яга, дополнительные поля OTRS.
3. Пакетные операции: выгрузка карточек в Tempo/Ягу, синхронизация статусов.
4. Мобильная вёрстка (в основном оптимизировано под desktop).

## 5. Пользовательский сценарий (текущее поведение)
1. Пользователь открывает Timesheets:
   - выбирает неделю стрелками или показывает выходные;
   - добавляет задачи (Tempo, Яга) или подтягивает шаблон/расписание;
   - правит карточки двойным кликом.
2. Для подготовки типовых карточек переходит в “Шаблоны”:
   - создаёт категорию, добавляет карточки (Tempo/Яга);
   - при необходимости переименовывает категорию в шапке;
   - карточки вытягиваются в Timesheets через picker (иконка “шаблоны” в колонке дня).
3. Раздел “Расписание” хранит недельную матрицу preset’ов; кнопка “Предзаполнить” переносит их в конкретный день Timesheets.

## 6. Историческое ТЗ (для справки)

> Изначальное ТЗ требовало пяти колонок рабочей недели, переключатель недель слева, кнопку показа выходных справа; кнопка “Добавить задачу” при наведении раскрывает Tempo/Яга/Предзаполнить/Шаблоны; карточки отображают тип системы, номер задачи, описание, цветовой статус (зелёный — выгружено, оранжевый — черновик, красный — неполные данные); API OTRS добавляет отдельные карточки; планировались настройки значений по умолчанию и фильтры справочников.

Текущая реализация следует этим принципам, а также добавляет:
- пересмотренный визуал (иконки, компактные модалки, гриды);
- inline rename в категориях;
- полноценный шаблон‑пикер внутри Timesheets.

## 7. Контакты и процесс
- Основной код: `app/views/timesheets`, `template_categories`, `template_cards`, Stimulus controllers в `app/javascript/controllers`.
- Перед доработками обновлять этот документ, чтобы отражать фактическое состояние.
