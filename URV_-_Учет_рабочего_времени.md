## Первоначальное ТЗ:
UVR - Учет рабочего времени
Необходимо разработать приложение которое упростит внесение данных по учету рабочего времени на порталах Tempo и Яга и тикет системе ОТРС.
Интерфейс приложения будет выглядеть как боковое меню с иконками и основной раздел с пятью колонками рабочей недели. Над колонками слева должен быть переключатель между неделями, а справа кнопка которая показывает\скрывает колонки выходных дней. Колонки будних дней должны ресайзится в зависимости от разрешения, так же если есть свободное место то колонки выходного дня не должны уменьшать основную неделю, а занимать свободное пространство. Левее от кнопки выходных дней будет появляться кнопки выгрузки карточек в Ягу\Темпо если такие карточки есть.
На колонке дня мы отображаем дату и сколько времени из 8 рабочих часов уже списано, ниже идет прогресс бар который отображает это соотношение. Ниже будет кнопка или фрейм "Добавить задачу" при наведении на которою она буде заменяться четырьмя новыми кнопками "Tempo" "Яга" "Предзаполнить" "Шаблоны", эти кнопки для экономия места тоже будут иконками.
Если пользователь выбирает "Tempo" или "Яга" создается форма для заполнения.
Для Tempo:
Задача (рядом добавим кнопку заглушку с помощью которой можно выполнить поиск задач)
Описание (многострочное поле)
Время
Вид работ (выпадающий список со значениями)
ЦС Действия (выпадающий список со значениями)
ЦС ИС (выпадающий список со значениями)
Для Яги:
Пространство
Задача (рядом добавим кнопку заглушку с помощью которой можно выполнить поиск задач)
Описание (многострочное поле)
Время
Вид работ (выпадающий список со значениями, отличается от Tempo)
В обоих вариантах формы должны быть кнопки "Сохранить" и "Отмена" (которая закрывает форму заполнения)
В дальнейшем нам необходимо будет реализовать в настройках возможность установить для всех полей кроме описания и времени значения по умолчанию. Так же дать возможность скрывать некоторые значения из выпадающих списков тоже через настройки.
После заполнения добавляется карточка. Сама карточка на виде недели будет показывать:
На первой строке карточки делаем Обозначение "Tempo" или "Яга" и номер задачи (слева), а напротив сколько времени на ее списали
Ниже будет отображать текст из описания (не более 2-3 строк, если не вмещается то в конце обрезаем и многоточие)
Карточки будут иметь цветовой индикатор (зеленый если карточка выгружена в темпо\ягу, оранжевый карточка созднана но еще не выгружена, красный когда у карточке не заполнены обязательные поля)
Будет третий вид карточек ОТРС, но их мы не будем создавать вручную. Карточка ОТРС будет создаваться после получения данных через АПИ ОТРС сколько времени работник потратил на заявки. В карточке ОТРС мы не будем указывать номер задачи, только обозначение "OTRS", потраченное время и описание "Время по заявкам за текущую дату", редактировать эту карточку будет нельзя.
На левой панели меню у нас будет вверху наш логотип и потом функциональные копки иконками :
"Расписание"
"Шаблоны"
"ОТРС"
Кнопка прижатая к низу:
Настройки
В "Расписание" у нас будет основной раздел с пятью колонками днями, по аналогии с основным разделом, но здесь мы можем добавить карточки Яги/Темпо которые потом будут добавляться на день недели по кнопки "Предзаполнить", для них нет необходимости делать разные цветовые обозначения, можем сделать их просто одного цвета, что бы они были в общем стиле, пусть будут оранжевые. Этот раздел будут служить для упрощения, например есть задачи которые повторяются каждый день (заполнение рабочего времени или работа с почтой) и один раз заполнив их на всю неделю мы сможем легко добавить необходимое в нужный день.
В разделе "Шаблоны" я хотел бы сделать таким образом, пользователь может сделать свои категории (до 10), для каждой категории он может создавать карточки.
По дизайну я вижу это так:
Верхний слой кнопка "Добавить категорию", нажимаю на нее пользователь должен будет ввести имя для категории.
После добавления это фрейм на котором будет название категории слева и кнопка настроек справа, так же около кнопки настроек есть кнопка + для добавления карточки (карточка может быть для яги или для темпо)
карточки в категории могут быть до 5 штук в ряд, если карточек больше, то создается новая строка с ними.
В настройках мы должны иметь возможность изменить название категории, удалить категорию и установить флажок будет ли эта категория свернута (при добавлении на основную неделю у нас будет интерфейс где по умолчанию категории будут в свернутом состоянии)
Сам интерфейс добавления этик карточек на основную неделю подразумевает что после нажатии кнопки шаблоны в колонке недели у нас открывается окошко где в свернутом состоянии мы видим все созданные категории, при нажатии на категорию у нас под ней появляется карточки, по три в строке, на карточке должен быть заначек + на нажатии на который карточка добавляется в тот день где была нажата кнопка шаблонов, а + превращается в галочку показывая что карточка добавлена, добавить можно так сколько необходимо карточек и потом закрыть это окошко с шаблонами
В настройках у нас будут заполняться данные для использование АПИ, а также возможность кастомизировать форму задав значения по умолчанию для некоторых полей, а так же скрыть отображение некоторых элементов из выпадающих списков.
Так же в VS Code у меня установлен плагин с Codex, возможно мы можем его тоже как то использовать для каких либо задач или проверок.
### Текущий реализованый функционал:
* недели с колонками по дням (Недельная доска);
* карточки работ (единая сущность `WorkItem`), два режима заполнения: **Tempo** и **Яга**;
* «Еженедельные шаблоны» (расписание на неделю) — **Presets**;
* «Коллекции шаблонов» на будущее использование — **Templates**;
* быстрые формы (Turbo Frames) и живые обновления шапок/сводки (Turbo Streams);
* авторизация **Devise**; фоновые задачи через **Sidekiq/Redis** (готово окружение);
* Tailwind + Stimulus для UI.
## Доменные сущности (модели)
* `User` — devise-пользователь.
* `WorkItem` — **основная карточка**. Поля (ключевые):
	* `user_id`, `date`, `minutes_spent`, `title`, `description`
	* `system` (`tempo`/`yaga`)
	* Tempo-специфика: `tempo_work_kind`, `tempo_cs_action`, `tempo_cs_is`
	* Yaga-специфика: `yaga_workspace`, `yaga_work_kind`
	* enum `state` (`incomplete`, `draft`, `synced`)
* `Preset` — «еженедельный набор» для дня недели (`weekday`).
* `PresetItem` — строки внутри `Preset`, по структуре близки к WorkItem (без статуса).
* `TemplateCategory` — папка шаблонов (до 10).
* `TemplateCard` — карточка-шаблон в категории (аналог PresetItem).
* (опционально) `UserPreference` — пользовательские настройки по умолчанию (резерв под будущее).
## Сервисы
* `PresetApplier` — применяет расписание за день → создаёт `WorkItem` из `PresetItem`.
* `WorkSummaryService` — считает «сводки»: минуты за день/неделю для быстрых обновлений UI.
## Контроллеры (и что они делают)
* `TimesheetsController#index`
	* строит неделю: `@week_start`, `@days`, `@items_by_day`, `@totals_by_day`
	* флаги интерфейса: `@show_weekend` (показывать выходные)
	* отрисовывает неделю с формами добавления.
	* **Turbo-модал** для шаблонов (пикер).
* `WorkItemsController`
	* `new` — форма (в turbo-frame) c учётом `system` и `frame_id`.
	* `create` — сохраняет и возвращает **Turbo Streams**:
		* перечерчивает список дня (`timesheets/_day_list`)
		* обновляет шапку дня (`timesheets/_day_header`)
		* обновляет сводку недели (`timesheets/_week_header`)
		* чистит `frame_id` (закрывает форму)
	* `edit` — форма в месте карточки (turbo-frame с `dom_id(item)`).
	* `update` — аналогично `create`, плюс перенос между днями (перерисовка обоих дней).
	* `destroy` — **перерисовывает целиком список дня**, шапку дня и сводку недели.
	* `show` — простая страница карточки (служебно).
* `PresetsController#index`
	* сетка из 5/7 колонок (как Timesheets), добавление «строк расписания», редактирование/удаление.
* `PresetItemsController`
	* формы `new/create/edit/update/destroy` внутри колонок Presets.
* `TemplatesPickerController`
	* отдаёт окно выбора шаблонов (для конкретного дня из Timesheets) с категорями и карточками; кликом создаёт `WorkItem` и обратно обновляет колонку дня.
* `TemplateCategoriesController` / `TemplateCardsController`
	* CRUD категорий и карточек шаблонов.
* `ApplicationController` — общие before_actions, devise-хелперы и пр.
## Представления (views)
### Layout и общие куски
* `app/views/layouts/application.html.erb`
	* подключает Inter (или другой шрифт), Tailwind, Stimulus, Turbo
	* рендерит **верхний топбар** и **левый сайдбар**
	* контейнер для основного контента.
* `app/views/shared/_topbar.html.erb`
	* тёмная полоса на всю ширину;
	* слева — кнопка «бургер» (сворачивает сайдбар) + логотип/название;
	* справа — email / иконка профиля и **иконка выхода**.
* `app/views/shared/_`card`.html.erb`
	* общая форма для карточек
* `app/views/shared/`_work_form.html`.erb`
	* тестовая общая форма для разделов
* `app/views/shared/_sidebar.html.erb`
	* меню разделов: «Расписание», «Еженед. шаблоны», «Шаблоны»
	* снизу — «Настройки»
	* работает со Stimulus-контроллером `SidebarController` (класс `-translate-x-full` ↔ `translate-x-0`).
### Timesheets
* `app/views/timesheets/index.html.erb`
	* шапка недели (стрелки, чекбокс «Показать выходные»)
	* `render` по дням: `timesheets/_day`, внутри:
		* `timesheets/_day_header` — дата + прогресс-бар + «итого за день»
		* **кнопка «Добавить»** с меню и turbo-frame для формы
		* `timesheets/_day_list` — список карточек; пустое состояние «Пока пусто…»
	* внизу — `<turbo-frame id="modal">` для модального окна шаблонов.
* `app/views/work_items/_card.html.erb`
	* карточка: цветная полоса статуса, «Тип» (Tempo/Yaga) слева, справа — иконка меню/удаления;
	* ниже — описание (трим до 2–3 строк), ещё ниже — слева номер/ключ, справа — время.
	* двойной клик открывает `edit` (html `ondblclick` или data-action).
* формы:
	* `app/views/work_items/_form_tempo.html.erb`
	* `app/views/work_items/_form_yaga.html.erb`
	* обе — с hidden-полями `week_start`, `weekend`, `frame_id` (для правильного ответа Turbo).
	* `new.html.erb`/`edit.html.erb` — обёртки, вставляющие нужную форму.
### Presets (еженедельные)
* `app/views/presets/index.html.erb`
	* визуально как Timesheets, но строки — это `PresetItem`;
	* кнопка «Предзаполнить» на Timesheets вызывает `TemplatesPickerController` (или `TimesheetsController#prefill` для расписания) — создаёт WorkItem на выбранный день.
### Templates (коллекции)
* `app/views/template_categories/index.html.erb`
	* сетка категорий; в категории — карточки шаблонов (до 5 в ряд, сворачиваемые) и кнопка «+».
* `app/views/templates_picker/_modal.html.erb`
	* модальное окно с категориями (в свернутом виде по умолчанию) и карточками; кликом «+» создаёт WorkItem и метит карточку «галочкой».
## JavaScript / Stimulus
`app/javascript/controllers`:
* `sidebar_controller.js` — сворачивание/разворачивание **левого** меню, хранит состояние (localStorage).
* `menu_controller.js` — логика верхнего бара (меню профиля/выход).
* `modal_controller.js` — модальное окно с шаблонами (open/close, backdrop).
* `time_input_controller.js` — парсинг поля «время» во всех формах.
* `weekend_toggle_controller.js` — чекбокс «Показать выходные» (меняет query-param).
* `card_controller.js` — dblclick→редактирование карточки.
* `accordion_controller.js` — сворачивание блоков (используется в шаблонах/категориях).
* `frame_close_controller.js` — «Отмена» закрывает Turbo-frame.
`app/javascript/controllers/index.js` — регистрация контроллеров + автозагрузка из каталога (eagerLoad).
## Turbo-потоки (на что обратить внимание)
* **Создание/редактирование/удаление** карточек возвращает **набор** `turbo_stream` действий:
	1. полная перерисовка списка дня (`replace day_list`) — так надпись «Пока пусто…» автоматически исчезает/появляется без сбоев;
	1. `replace` шапки дня;
	1. `replace` сводки недели;
	1. очистка `frame_id` (закрыть форму).
* Такой подход устранил баг «карточка из списка не исчезает при серийном удалении».
## Маршруты (главные)
* `/` → `TimesheetsController#index` (alias `/timesheets`)
* `/presets` → расписание недели; `preset_items` — nested CRUD
* `/template_categories` → категории; `template_cards` — nested CRUD
* `/templates_picker` → модальное окно выбора шаблонов
* devise-маршруты `/users/...`
## Как это сейчас выглядит для пользователя (потоки)
1. **Добавить карточку**
Нажимаешь «Добавить задачу» → выбираешь Tempo/Яга → открывается форма (в колонке дня) → Submit → карточка появляется, прогресс-бар и сводки обновляются, форма закрывается.
1. **Еженедельные шаблоны**
В разделе «Еженед. шаблоны» собираешь набор строк для понедельника/вторника/… → на Timesheets жмёшь «Предзаполнить» для дня → карточки создаются из расписания.
1. **Шаблоны (категории)**
В разделе «Шаблоны» формируешь карточки по тематическим категориям → на Timesheets в колонке дня жмёшь «Шаблоны» → открывается модалка → по клику «+» нужные карточки добавляются в этот день.
## Как работает «живое» обновление
1. **Создание карточки**
	* `WorkItemsController#create` → `streams_after_create`:
		* `replace day_list` (вместо просто `.append` — чтобы убрать «Пока пусто»)
		* `replace day_header` (итог дня)
		* `replace week_header` (итог недели)
		* `update frame_id` пустой строкой (закрыть форму)
1. **Редактирование карточки**
	* Если изменили **дату** — полная переразметка **старого** и **нового** дней (списки + шапки), затем — шапка недели.
	* Если дата та же — перерисовка карточки и шапки дня + шапка недели.
1. **Удаление карточки**
	* Полная перерисовка **списка дня** (чтобы корректно показывалась заглушка)
	* Обновление шапки дня и недели.
	## Возможные баги, о которых стоит помнить
	* Если **снова перестанет сворачиваться** сайдбар — проверь, что `data-controller="sidebar"` и `data-sidebar-target="aside"` стоят на правильных элементах, и нет конфликтов двойной инициализации в JS.
	* Если появится «Content missing» — как правило, это турбо-фрейм, в который ничего не зарендерили. Проверяй `turbo_frame_tag` id и соответствующие рендеры.
	* Если шапка дня/недели не обновляется — проверь, что в ответе Turbo Stream пришли **replace** для `day_header_dom_id(date)` и `week_header_dom_id`.




# Что можно сделать дальше:
* Доделать UI - сейчас на очереди привести впорядок Presets/Templates
* Единый компонент «карточки»  и формы создания карточек для Timesheets/Presets/Templates (меньше дублирования).
* Настройки профиля (UserPreference: значения по умолчанию для форм + скрытие полей).
* Интеграции с API Tempo/OTRS/Jaga

